package com.example.pvz2leveleditor.views.editor.pages.event

import android.widget.Toast
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.ExperimentalLayoutApi
import androidx.compose.foundation.layout.FlowRow
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyListState
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.automirrored.filled.HelpOutline
import androidx.compose.material.icons.filled.AddCircleOutline
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Eco
import androidx.compose.material.icons.filled.Layers
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.InputChip
import androidx.compose.material3.InputChipDefaults
import androidx.compose.material3.ModalBottomSheet
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Slider
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.TopAppBarDefaults
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableFloatStateOf
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.pvz2leveleditor.data.Repository.PlantRepository
import com.example.pvz2leveleditor.data.PvzLevelFile
import com.example.pvz2leveleditor.data.RtidParser
import com.example.pvz2leveleditor.data.WaveActionData
import com.example.pvz2leveleditor.data.Repository.ZombiePropertiesRepository
import com.example.pvz2leveleditor.data.Repository.ZombieRepository
import com.example.pvz2leveleditor.data.ZombieSpawnData
import com.example.pvz2leveleditor.views.editor.EditorHelpDialog
import com.example.pvz2leveleditor.views.editor.HelpSection
import com.example.pvz2leveleditor.views.editor.LaneRow
import com.example.pvz2leveleditor.views.editor.NumberInputInt
import com.example.pvz2leveleditor.views.editor.ZombieEditSheetContent
import com.google.gson.Gson
import kotlin.math.roundToInt

private val gson = Gson()

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SpawnZombiesJitteredWaveActionPropsEP(
    rtid: String,
    onBack: () -> Unit,
    rootLevelFile: PvzLevelFile,
    onRequestZombieSelection: ((String) -> Unit) -> Unit,
    onRequestPlantSelection: ((String) -> Unit) -> Unit,
    scrollState: LazyListState
) {
    val currentAlias = RtidParser.parse(rtid)?.alias ?: ""
    val focusManager = LocalFocusManager.current
    var showHelpDialog by remember { mutableStateOf(false) }
    val context = LocalContext.current

    var batchLevelFloat by remember { mutableFloatStateOf(1f) }
    var showBatchConfirmDialog by remember { mutableStateOf(false) }

    val actionDataState = remember {
        val obj = rootLevelFile.objects.find { it.aliases?.contains(currentAlias) == true }
        val data = try {
            gson.fromJson(obj?.objData, WaveActionData::class.java)
        } catch (e: Exception) {
            WaveActionData()
        }

        data.zombies.forEach { zombie ->
            val parsed = RtidParser.parse(zombie.type)
            val realTypeAlias = parsed?.alias ?: ""
            val typeName = ZombiePropertiesRepository.getTypeNameByAlias(realTypeAlias)

            zombie.isElite = ZombieRepository.isElite(typeName)
            if (zombie.isElite) {
                zombie.level = null
            } else if ((zombie.level ?: 1) < 1) {
                zombie.level = 1
            }
        }
        mutableStateOf(data)
    }

    var addingToRowIndex by remember { mutableStateOf<Int?>(null) }
    var editingZombie by remember { mutableStateOf<ZombieSpawnData?>(null) }
    var showBottomSheet by remember { mutableStateOf(false) }

    fun sync(newData: WaveActionData) {
        actionDataState.value = newData
        rootLevelFile.objects.find { it.aliases?.contains(currentAlias) == true }?.let {
            it.objData = gson.toJsonTree(newData)
        }
    }

    fun handleAddZombie() {
        onRequestZombieSelection { selectedId ->
            val alias = RtidParser.parse(selectedId)?.alias ?: selectedId
            val typeName = ZombiePropertiesRepository.getTypeNameByAlias(alias)
            val isElite = ZombieRepository.isElite(typeName)

            val newZombie = ZombieSpawnData(
                type = RtidParser.build(typeName, "ZombieTypes"),
                row = addingToRowIndex,
                level = if (isElite) null else 1,
                isElite = isElite
            )

            val newList = actionDataState.value.zombies.toMutableList()
            newList.add(newZombie)
            sync(actionDataState.value.copy(zombies = newList))
        }
    }

    fun executeBatchUpdate() {
        val targetLevel = batchLevelFloat.roundToInt()
        val currentZombies = actionDataState.value.zombies.toList()
        var changeCount = 0

        val newZombies = currentZombies.map { zombie ->
            if (!zombie.isElite) {
                changeCount++
                zombie.copy(level = targetLevel)
            } else {
                zombie
            }
        }.toMutableList()

        sync(actionDataState.value.copy(zombies = newZombies))
        showBatchConfirmDialog = false
        Toast.makeText(
            context,
            "已将 $changeCount 只僵尸设为 ${targetLevel} 阶",
            Toast.LENGTH_SHORT
        ).show()
    }

    // 底部抽屉
    if (showBottomSheet && editingZombie != null) {
        ModalBottomSheet(
            onDismissRequest = { showBottomSheet = false; editingZombie = null },
            containerColor = Color.White
        ) {
            ZombieEditSheetContent(
                originalZombie = editingZombie!!,
                onValueChange = { updatedZombie ->
                    val currentList = actionDataState.value.zombies.toMutableList()
                    val index = currentList.indexOf(editingZombie!!)
                    if (index != -1) {
                        currentList[index] = updatedZombie
                        editingZombie = updatedZombie
                        sync(actionDataState.value.copy(zombies = currentList))
                    }
                },
                onDelete = {
                    val currentList = actionDataState.value.zombies.toMutableList()
                    currentList.remove(editingZombie!!)
                    sync(actionDataState.value.copy(zombies = currentList))
                    showBottomSheet = false
                    editingZombie = null
                }
            )
        }
    }

    if (showBatchConfirmDialog) {
        AlertDialog(
            onDismissRequest = { showBatchConfirmDialog = false },
            icon = { Icon(Icons.Default.Check, null) },
            title = { Text("确认批量应用？") },
            text = {
                val level = batchLevelFloat.roundToInt()
                Text("此操作将把当前波次内的所有僵尸等级统一设置为 $level 阶。")
            },
            confirmButton = {
                Button(
                    onClick = { executeBatchUpdate() },
                    colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF388E3C))
                ) {
                    Text("确认覆盖")
                }
            },
            dismissButton = {
                TextButton(onClick = { showBatchConfirmDialog = false }) { Text("取消") }
            }
        )
    }

    Scaffold(
        modifier = Modifier.pointerInput(Unit) {
            detectTapGestures(onTap = {
                focusManager.clearFocus() // 点击空白处清除焦点
            })
        },
        topBar = {
            TopAppBar(
                title = {
                    Column {
                        Text("编辑 $currentAlias", fontWeight = FontWeight.Bold, fontSize = 18.sp)
                        Text("事件类型：自然出怪", fontSize = 14.sp, fontWeight = FontWeight.Normal)
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.AutoMirrored.Filled.ArrowBack, "Back", tint = Color.White)
                    }
                },
                actions = {
                    IconButton(onClick = { showHelpDialog = true }) {
                        Icon(Icons.AutoMirrored.Filled.HelpOutline, "帮助说明", tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color(0xFF1976D2),
                    titleContentColor = Color.White,
                    actionIconContentColor = Color.White
                )
            )
        }
    ) { padding ->
        if (showHelpDialog) {
            EditorHelpDialog(
                title = "传送带模块说明",
                onDismiss = { showHelpDialog = false },
                themeColor = Color(0xFF1976D2)
            ) {
                HelpSection(
                    title = "基本原理",
                    body = "传送带模式下，植物不会消耗阳光，而是按照设定的权重随机生成卡片。你需要配置植物池、生成速度以及刷新延迟。"
                )
                HelpSection(
                    title = "植物池与权重",
                    body = "权重(Weight)决定了植物出现的概率。数值越大，出现几率越高。您可以设置“最大数量”来限制某种植物在场上的总量（达到上限后该植物权重会根据倍率降低或降为0）。"
                )
                HelpSection(
                    title = "刷新延迟 (Drop Delay)",
                    body = "控制卡片生成的间隔时间。当传送带上积压的卡片数量(MaxPackets)达到设定阈值时，生成下一张卡片的等待时间(Delay)会发生变化。通常积压越多，生成越慢。"
                )
                HelpSection(
                    title = "传输速度 (Speed)",
                    body = "控制卡片在传送带上移动的物理速度。标准速度为 100。同样可以根据积压数量进行分段变速。"
                )
                HelpSection(
                    title = "注意事项",
                    body = "“MaxPackets=0” 的基础项是必须存在的，它代表传送带为空时的默认状态，不可删除。"
                )
            }
        }
        LazyColumn(
            state = scrollState,
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .background(Color(0xFFF5F5F5)),
            contentPadding = PaddingValues(bottom = 32.dp)
        ) {
            // 1-5 行
            items(5) { index ->
                val rowNum = index + 1
                val zombiesInRow = actionDataState.value.zombies.filter { it.row == rowNum }

                LaneRow(
                    laneLabel = "第 $rowNum 行",
                    laneColor = Color(0xFF4CAF50),
                    zombies = zombiesInRow,
                    onAddClick = {
                        addingToRowIndex = rowNum
                        handleAddZombie()
                    },
                    onZombieClick = { zombie ->
                        editingZombie = zombie
                        showBottomSheet = true
                    }
                )
            }

            // 随机行
            item {
                val randomZombies =
                    actionDataState.value.zombies.filter { it.row == null || it.row == 0 }
                LaneRow(
                    laneLabel = "随机行",
                    laneColor = Color(0xFF9E9E9E),
                    zombies = randomZombies,
                    onAddClick = {
                        addingToRowIndex = null
                        handleAddZombie()
                    },
                    onZombieClick = { zombie ->
                        editingZombie = zombie
                        showBottomSheet = true
                    }
                )
            }

            item {
                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp, vertical = 8.dp),
                    colors = CardDefaults.cardColors(containerColor = Color.White),
                    elevation = CardDefaults.cardElevation(1.dp)
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        // 标题行
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            Icon(
                                Icons.Default.Layers,
                                null,
                                tint = Color(0xFF1976D2),
                                modifier = Modifier.size(20.dp)
                            )
                            Spacer(Modifier.width(8.dp))
                            Text(
                                "批量设置等级",
                                fontWeight = FontWeight.Bold,
                                fontSize = 16.sp,
                                color = Color(0xFF1976D2)
                            )
                            Spacer(Modifier.weight(1f))
                            // 当前值显示
                            Text(
                                text = "${batchLevelFloat.roundToInt()} 阶",
                                fontWeight = FontWeight.Bold,
                                fontSize = 18.sp,
                                color = Color(0xFF1976D2)
                            )
                        }

                        Spacer(Modifier.height(12.dp))

                        // 操作行
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            // 拖动条
                            Slider(
                                value = batchLevelFloat,
                                onValueChange = { batchLevelFloat = it },
                                valueRange = 1f..10f,
                                steps = 8,
                                modifier = Modifier.weight(1f)
                            )

                            Spacer(Modifier.width(16.dp))

                            // 确认按钮
                            Button(
                                onClick = { showBatchConfirmDialog = true },
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = Color(
                                        0xFF1976D2
                                    )
                                ),
                                contentPadding = PaddingValues(horizontal = 12.dp),
                                modifier = Modifier.height(36.dp)
                            ) {
                                Text("一键应用", fontSize = 13.sp)
                            }
                        }

                        Text(
                            text = "将本波次所有僵尸设为指定等级（精英不受影响）",
                            fontSize = 11.sp,
                            color = Color.Gray,
                            modifier = Modifier.padding(top = 4.dp, start = 4.dp)
                        )
                    }
                }
            }

            item {
                // 获取当前掉落植物列表
                val spawnPlantList = actionDataState.value.spawnPlantName ?: mutableListOf()
                // 判断逻辑：列表有内容则为"掉落植物"，无内容则为"掉落能量豆"
                val isDroppingPlants = spawnPlantList.isNotEmpty()
                val cardTitle = if (isDroppingPlants) "掉落物配置 (植物)" else "掉落物配置 (能量豆)"
                val cardColor =
                    if (isDroppingPlants) Color(0xFFE65100) else Color(0xFF2E7D32) // 橙色区分植物掉落

                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp, vertical = 8.dp),
                    colors = CardDefaults.cardColors(containerColor = Color.White),
                    elevation = CardDefaults.cardElevation(1.dp)
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        // 标题栏
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            Icon(
                                Icons.Default.Eco,
                                null,
                                tint = cardColor,
                                modifier = Modifier.size(20.dp)
                            )
                            Spacer(Modifier.width(8.dp))
                            Text(
                                cardTitle,
                                fontWeight = FontWeight.Bold,
                                fontSize = 16.sp,
                                color = cardColor
                            )
                        }

                        HorizontalDivider(modifier = Modifier.padding(vertical = 12.dp))

                        // --- 区域 1: SpawnPlantName 列表管理 ---
                        Text(
                            "指定掉落植物 (SpawnPlantName)",
                            fontSize = 13.sp,
                            fontWeight = FontWeight.Bold
                        )
                        Spacer(Modifier.height(8.dp))

                        // 植物列表展示 (FlowRow 或 换行布局)
                        @OptIn(ExperimentalLayoutApi::class)
                        FlowRow(
                            horizontalArrangement = Arrangement.spacedBy(8.dp),
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            spawnPlantList.forEachIndexed { index, plantType ->
                                InputChip(
                                    selected = true,
                                    onClick = {},
                                    label = { Text(PlantRepository.getName(plantType)) },
                                    trailingIcon = {
                                        Icon(
                                            Icons.Default.Close,
                                            contentDescription = "删除",
                                            modifier = Modifier
                                                .size(16.dp)
                                                .clickable {
                                                    val newList = spawnPlantList.toMutableList()
                                                    newList.removeAt(index)
                                                    val finalData =
                                                        if (newList.isEmpty()) null else newList
                                                    sync(actionDataState.value.copy(spawnPlantName = finalData))
                                                }
                                        )
                                    },
                                    colors = InputChipDefaults.inputChipColors(
                                        selectedContainerColor = Color(0xFFFFF3E0),
                                        selectedLabelColor = Color(0xFFE65100)
                                    )
                                )
                            }

                            // 添加植物按钮
                            InputChip(
                                selected = false,
                                onClick = {
                                    onRequestPlantSelection { selectedId ->
                                        val newList = spawnPlantList.toMutableList()
                                        if (!newList.contains(selectedId)) {
                                            newList.add(selectedId)
                                            sync(actionDataState.value.copy(spawnPlantName = newList))
                                        }
                                    }
                                },
                                label = { Text("添加植物") },
                                leadingIcon = {
                                    Icon(
                                        Icons.Default.AddCircleOutline,
                                        null,
                                        Modifier.size(18.dp)
                                    )
                                }
                            )
                        }

                        Spacer(Modifier.height(16.dp))

                        val countLabel = if (isDroppingPlants) {
                            "携带上述植物的僵尸数量 (AdditionalPlantFood)"
                        } else {
                            "携带能量豆的僵尸数量 (AdditionalPlantFood)"
                        }

                        NumberInputInt(
                            value = actionDataState.value.additionalPlantFood ?: 0,
                            onValueChange = { newVal ->
                                val finalVal = if (newVal <= 0) null else newVal
                                sync(actionDataState.value.copy(additionalPlantFood = finalVal))
                            },
                            label = countLabel,
                            modifier = Modifier.fillMaxWidth()
                        )

                        // 解释文本
                        val countVal = actionDataState.value.additionalPlantFood ?: 0
                        val explainText = if (countVal > 0) {
                            if (isDroppingPlants)
                                "本波次将有 $countVal 只僵尸掉落列表中的植物"
                            else
                                "本波次将有 $countVal 只僵尸携带能量豆"
                        } else {
                            "无额外掉落"
                        }

                        Text(
                            text = explainText,
                            fontSize = 12.sp,
                            color = Color.Gray,
                            modifier = Modifier.padding(top = 6.dp)
                        )
                    }
                }
            }
        }
    }
}
