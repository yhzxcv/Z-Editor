package com.example.pvz2leveleditor.data

import android.content.Context
import com.google.gson.Gson
import java.io.InputStreamReader

object ZombiePropertiesRepository {
    private val gson = Gson()

    private val statsCache = mutableMapOf<String, ZombieStats>()
    private val aliasToTypeCache = mutableMapOf<String, String>()

    private var isInitialized = false

    fun init(context: Context) {
        if (isInitialized) return

        try {
            // 【核心修正 1】加载文件名改为 PropertySheets.json
            val propsFileMap = loadReferenceFile(context, "reference/PropertySheets.json")

            // 加载 ZombieTypes.json
            val typesFileMap = loadReferenceFile(context, "reference/ZombieTypes.json")

            typesFileMap.forEach { (alias, typeObj) ->
                try {
                    val typeData = gson.fromJson(typeObj.objData, ZombieTypeData::class.java)
                    val typeName = typeData.typeName

                    if (!typeName.isNullOrBlank()) {
                        aliasToTypeCache[alias] = typeName
                        aliasToTypeCache[typeName] = typeName

                        val propsAlias = RtidParser.parse(typeData.properties)?.alias ?: ""

                        val propsObj = propsFileMap[propsAlias]

                        if (propsObj != null) {
                            val sheet = gson.fromJson(propsObj.objData, ZombiePropertySheetData::class.java)

                            val stats = ZombieStats(
                                id = typeName,
                                hp = sheet.hitpoints,
                                cost = sheet.wavePointCost,
                                weight = sheet.weight.toInt(),
                                speed = sheet.speed,
                                eatDPS = sheet.eatDPS,
                                sizeType = sheet.sizeType
                            )
                            statsCache[typeName] = stats
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                }
            }
            isInitialized = true
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    private fun loadReferenceFile(context: Context, path: String): Map<String, PvzObject> {
        return try {
            val inputStream = context.assets.open(path)
            val root = gson.fromJson(InputStreamReader(inputStream), PvzLevelFile::class.java)
            root.objects.associateBy { it.aliases?.firstOrNull() ?: "unknown" }
        } catch (e: Exception) {
            // 建议：如果加载失败，打印日志方便排查
            println("Error loading $path: ${e.message}")
            emptyMap()
        }
    }

    fun getTypeNameByAlias(alias: String): String = aliasToTypeCache[alias] ?: alias

    fun getStats(typeName: String): ZombieStats =
        statsCache[typeName] ?: ZombieStats(typeName, 0.0, 0, 0, 0.0, 0.0, "unknown")

    fun getZombiePoints(typeName: String): Int = getStats(typeName).cost
}